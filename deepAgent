import os
from typing import Literal
from tavily import TavilyClient

# ä½¿ç”¨é˜¿é‡Œäº‘DashScopeï¼ˆé€šä¹‰åƒé—®ï¼‰ä½œä¸ºæ›¿ä»£
from langchain_openai import ChatOpenAI
from deepagents import create_deep_agent

# ========== 1. é…ç½®DashScope ==========
DASHSCOPE_API_KEY = "sk-fc3984cf3d8a4214a0ea781b417a25b7"  # ç¤ºä¾‹APIå¯†é’¥ï¼Œè¯·æ›¿æ¢ä¸ºä½ çš„çœŸå®å¯†é’¥
TAVILY_API_KEY = "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"

# è®¾ç½®ç¯å¢ƒå˜é‡
os.environ["TAVILY_API_KEY"] = TAVILY_API_KEY

# ========== 2. åˆ›å»ºæœç´¢å·¥å…· ==========
tavily_client = TavilyClient(api_key=TAVILY_API_KEY)

def internet_search(
    query: str,
    max_results: int = 5,
    topic: Literal["general", "news", "finance"] = "general",
    include_raw_content: bool = False,
):
    """è¿è¡Œç½‘é¡µæœç´¢"""
    return tavily_client.search(
        query,
        max_results=max_results,
        include_raw_content=include_raw_content,
        topic=topic,
    )

# ========== 3. åˆ›å»ºDeep Agent ==========
research_instructions = """ä½ æ˜¯ä¸€ä½ä¸“å®¶ç ”ç©¶å‘˜ã€‚ä½ çš„å·¥ä½œæ˜¯è¿›è¡Œæ·±å…¥ç ”ç©¶å¹¶æ’°å†™ä¸€ä»½å®Œæ•´çš„æŠ¥å‘Šã€‚

ä½ æ‹¥æœ‰äº’è”ç½‘æœç´¢å·¥å…·ä½œä¸ºä¸»è¦çš„ä¿¡æ¯æ”¶é›†æ‰‹æ®µã€‚

## `internet_search`
ä½¿ç”¨æ­¤å·¥å…·è¿è¡Œäº’è”ç½‘æœç´¢ã€‚ä½ å¯ä»¥æŒ‡å®šè¿”å›ç»“æœçš„æœ€å¤§æ•°é‡ã€ä¸»é¢˜ä»¥åŠæ˜¯å¦åŒ…å«åŸå§‹å†…å®¹ã€‚

## å·¥ä½œæµç¨‹
1. é¦–å…ˆè§„åˆ’ä½ çš„ç ”ç©¶æ–¹æ³•
2. ä½¿ç”¨æœç´¢å·¥å…·æ”¶é›†ç›¸å…³ä¿¡æ¯
3. ç®¡ç†æœç´¢ç»“æœ
4. ç»¼åˆä¿¡æ¯å¹¶æ’°å†™æŠ¥å‘Š
"""

# åˆ›å»ºDashScopeæ¨¡å‹ï¼ˆå…¼å®¹OpenAIæ¥å£ï¼‰
model = ChatOpenAI(
    model="qwen-max",  # æˆ– qwen-turbo, qwen-plus
    api_key=DASHSCOPE_API_KEY,
    base_url="https://dashscope.aliyuncs.com/compatible-mode/v1",
    temperature=0.1
)

# åˆ›å»ºDeep Agent
agent = create_deep_agent(
    tools=[internet_search],
    system_prompt=research_instructions,
    model=model
)

# ========== 4. è¿è¡ŒAgent ==========
if __name__ == "__main__":
    print("ğŸ§  é€šä¹‰åƒé—®ç ”ç©¶Agentå¯åŠ¨...\n")

    result = agent.invoke({
        "messages": [{"role": "user", "content": "ä»€ä¹ˆæ˜¯LangGraphï¼Ÿè¯·ç”¨å®ƒå†™ä¸€ä¸ªç®€å•çš„æ¶æ„æ¦‚è¿°ã€‚"}]
    })

    print("ğŸ“„ æœ€ç»ˆæŠ¥å‘Š:\n")
    print(result["messages"][-1].content)
